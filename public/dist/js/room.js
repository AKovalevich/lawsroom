function Room(e){this.me=e.me,this.signalServer=e.signalServer,this.iceServers=e.iceServers,this.id,this.signal,this.stream,this.peers={},this.channels={},this.handles={}}Room.prototype.on=function(e,n){this.handles[e]=n},Room.prototype["in"]=function(){this.signal=new WebSocket(this.signalServer+encodeURIComponent(this.me)),this.signal.onopen=this._signal_open.bind(this),this.signal.onclose=this._signal_close.bind(this),this.signal.onerror=this._signal_error.bind(this),this.signal.onmessage=this._signal_message.bind(this)},Room.prototype._signal_open=function(e){print("r:e:signal_open"),"function"==typeof this.handles.signal_open&&this.handles.signal_open(e)},Room.prototype._signal_close=function(e){print("r:e:signal_close"),this._clean(),"function"==typeof this.handles.signal_close&&this.handles.signal_close(e)},Room.prototype._signal_error=function(e){print("r:e:signal_error"),this._clean(),"function"==typeof this.handles.signal_error&&this.handles.signal_error(e)},Room.prototype._signalSend=function(e){print("r:o:"+JSON.stringify(e)),this.signal.send(JSON.stringify(e))},Room.prototype._clean=function(){this.id=void 0,this.stream=void 0;for(var e in this.peers)this.peers[e].c.close(),delete this.peers[e];for(var e in this.channels)"open"===this.channels[e].readyState&&this.channels[e].close(),delete this.channels[e]},Room.prototype._newPeerConnection=function(){return new RTCPeerConnection({iceServers:this.iceServers})},Room.prototype.setStream=function(e){this.stream=e},Room.prototype.create=function(e){this._signalSend({For:"create",Room:e})},Room.prototype.join=function(e){this._signalSend({For:"join",Room:e})},Room.prototype.leave=function(){this._signalSend({For:"leave",Room:this.id})},Room.prototype.send=function(e){for(var n in this.channels)"open"===this.channels[n].readyState&&this.channels[n].send(e)},Room.prototype.peersCount=function(){var e=0;for(var n in this.peers)"connected"!==this.peers[n].readyState&&"completed"!==this.peers[n].iceConnectionState||e++;return e},Room.prototype.channelsCount=function(){var e=0;for(var n in this.channels)"open"===this.channels[n].readyState&&e++;return e},Room.prototype._signal_message=function(e){print("r:i:"+e.data);var n=JSON.parse(e.data);switch(n.For){case"create":this.id=n.Room,"function"==typeof this.handles.message_create&&(print("r:e:message_create"),this.handles.message_create(n));break;case"join":this.id=n.Room,"function"==typeof this.handles.message_join&&(print("r:e:message_join"),this.handles.message_join(n));break;case"join_older":this._join_older(n);break;case"join_newer":this._join_newer(n);break;case"leave":this._clean(),"function"==typeof this.handles.message_leave&&(print("r:e:message_leave"),this.handles.message_leave(n));break;case"icecandidate":this.peers[n.From].hasRSDP?this.peers[n.From].c.addIceCandidate(new RTCIceCandidate(n.Data)):this.peers[n.From].candidates.push(n.Data);break;case"offer":var t=this;t.peers[n.From].c.setRemoteDescription(new RTCSessionDescription(n.Data),function(){for(t.peers[n.From].hasRSDP=!0;;){var e=t.peers[n.From].candidates.shift();if(!e)break;t.peers[n.From].c.addIceCandidate(new RTCIceCandidate(e))}t.peers[n.From].c.createAnswer(function(e){t.peers[n.From].c.setLocalDescription(e,function(){t._signalSend({Room:t.id,From:t.me,To:n.From,For:"answer",Data:e})},function(e){print("r:e:on got offer, set local dsp error")})},function(e){print("r:e:on got offer, create answer error")})},function(e){print("r:e:on got offer, set remote dsp error")});break;case"answer":var t=this;t.peers[n.From].c.setRemoteDescription(new RTCSessionDescription(n.Data),function(){for(t.peers[n.From].hasRSDP=!0;;){var e=t.peers[n.From].candidates.shift();if(!e)break;t.peers[n.From].c.addIceCandidate(new RTCIceCandidate(e))}},function(e){print("r:e:on got answer, set remote dsp error")});break;case"notice":"function"==typeof this.handles.message_notice&&(print("r:e:message_notice"),this.handles.message_notice(n))}},Room.prototype._join_older=function(e){var n=this,t=n._newPeerConnection();n.peers[e.Data]={c:void 0,hasRSDP:!1,candidates:[]},n.peers[e.Data].c=t,n.stream&&t.addStream(n.stream),t.onaddstream=function(t){"function"==typeof n.handles.stream_add&&(print("r:e:"+e.Data+":stream_add"),n.handles.stream_add(e.Data,t.stream,t))},t.onremovestream=function(t){"function"==typeof n.handles.stream_remove&&(print("r:e:"+e.Data+":stream_remove"),n.handles.stream_remove(e.Data,t))},t.onicecandidate=function(t){t.candidate&&n._signalSend({Room:n.id,From:n.me,To:e.Data,For:"icecandidate",Data:t.candidate})};var a=t.createDataChannel(e.Data);a.onopen=function(t){n.channels[e.Data]=a,"function"==typeof n.handles.channel_open&&(print("r:e:"+e.Data+":channel_open"),n.handles.channel_open(e.Data,t))},a.onmessage=function(t){"function"==typeof n.handles.channel_message&&(print("r:e:"+e.Data+":channel_message"),n.handles.channel_message(e.Data,t.data,t))},a.onclose=function(t){"function"==typeof n.handles.channel_close&&(print("r:e:"+e.Data+":channel_close"),n.handles.channel_close(e.Data,t))},t.createOffer(function(a){t.setLocalDescription(a,function(){n._signalSend({Room:n.id,From:n.me,To:e.Data,For:"offer",Data:a})},function(n){print("r:error:"+e.Data+":set local dsp error on create offer")})},function(n){print("r:error:"+e.Data+":create offer error")}),t.oniceconnectionstatechange=function(a){print("r:ics:offer:"+e.Data+":"+t.iceConnectionState),"connected"===t.iceConnectionState&&"function"==typeof n.handles.peer_open&&(print("r:e:"+e.Data+":peer_open"),n.handles.peer_open(e.Data,a)),"completed"===t.iceConnectionState&&"function"==typeof n.handles.peer_open&&(print("r:e:"+e.Data+":peer_open"),n.handles.peer_open(e.Data,a)),"disconnected"===t.iceConnectionState&&"function"==typeof n.handles.peer_close&&(print("r:e:"+e.Data+":peer_close"),n.handles.peer_close(e.Data,a)),"closed"===t.iceConnectionState&&"function"==typeof n.handles.peer_close&&(print("r:e:"+e.Data+":peer_close"),n.handles.peer_close(e.Data,a)),"failed"===t.iceConnectionState&&"function"==typeof n.handles.peer_close&&(print("r:e:"+e.Data+":peer_close"),n.handles.peer_close(e.Data,a))},t.onsignalingstatechange=function(n){print("r:ss:offer:"+e.Data+":"+t.signalingState)}},Room.prototype._join_newer=function(e){var n=this,t=n._newPeerConnection();n.peers[e.Data]={c:void 0,hasRSDP:!1,candidates:[]},n.peers[e.Data].c=t,n.stream&&t.addStream(n.stream),t.onaddstream=function(t){"function"==typeof n.handles.stream_add&&(print("r:e:"+e.Data+":stream_add"),n.handles.stream_add(e.Data,t.stream,t))},t.onremovestream=function(t){"function"==typeof n.handles.stream_remove&&(print("r:e:"+e.Data+":stream_remove"),n.handles.stream_remove(e.Data,t))},t.onicecandidate=function(t){t.candidate&&n._signalSend({Room:n.id,From:n.me,To:e.Data,For:"icecandidate",Data:t.candidate})},t.oniceconnectionstatechange=function(a){print("r:ics:anwser:"+e.Data+":"+t.iceConnectionState),"connected"===t.iceConnectionState&&"function"==typeof n.handles.peer_open&&(print("r:e:"+e.Data+":peer_open"),n.handles.peer_open(e.Data,a)),"completed"===t.iceConnectionState&&"function"==typeof n.handles.peer_open&&(print("r:e:"+e.Data+":peer_open"),n.handles.peer_open(e.Data,a)),"disconnected"===t.iceConnectionState&&"function"==typeof n.handles.peer_close&&(print("r:e:"+e.Data+":peer_close"),n.handles.peer_close(e.Data,a)),"closed"===t.iceConnectionState&&"function"==typeof n.handles.peer_close&&(print("r:e:"+e.Data+":peer_close"),n.handles.peer_close(e.Data,a)),"failed"===t.iceConnectionState&&"function"==typeof n.handles.peer_close&&(print("r:e:"+e.Data+":peer_close"),n.handles.peer_close(e.Data,a))},t.onsignalingstatechange=function(n){print("r:ss:anwser:"+e.Data+":"+t.signalingState)},t.ondatachannel=function(t){var a=t.channel;a.onopen=function(t){n.channels[e.Data]=a,"function"==typeof n.handles.channel_open&&(print("r:e:"+e.Data+":channel_open"),n.handles.channel_open(e.Data,t))},a.onmessage=function(t){"function"==typeof n.handles.channel_message&&(print("r:e:"+e.Data+":channel_message"),n.handles.channel_message(e.Data,t.data,t))},a.onclose=function(t){"function"==typeof n.handles.channel_close&&(print("r:e:"+e.Data+":channel_close"),n.handles.channel_close(e.Data,t))}}};